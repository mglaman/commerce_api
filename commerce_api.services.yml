services:
  commerce_api.jsonapi_controller_shim:
    parent: jsonapi.entity_resource
    class: Drupal\commerce_api\EntityResourceShim

  commerce_api.field_access:
    class: Drupal\commerce_api\FieldAccess
    arguments: ['@current_route_match']

  commerce_api.cart_token_session:
    class: Drupal\commerce_api\CartTokenSession
    decorates: commerce_cart.cart_session
    public: false
    arguments: ['@commerce_api.cart_token_session.inner', '@request_stack', '@tempstore.shared']
  commerce_api.cart_token_session_configuration:
    class: Drupal\commerce_api\Session\CartTokenSessionConfiguration
    decorates: session_configuration
    public: false
    arguments: ['@commerce_api.cart_token_session_configuration.inner']
  commerce_api.token_cart_convert_subscriber:
    class: Drupal\commerce_api\EventSubscriber\CartTokenSubscriber
    arguments: ['@commerce_cart.cart_session', '@tempstore.shared']
    tags:
      - { name: event_subscriber }

  # @see https://www.drupal.org/project/commerce/issues/3088598
  commerce_api.published_availability_checker:
    class: Drupal\commerce_api\AvailabilityChecker\PublishedAvailabilityChecker
    tags:
      - { name: commerce.availability_checker }

  commerce_api.store_header_resolver:
    class: Drupal\commerce_api\Resolvers\CurrentStoreHeaderResolver
    arguments: ['@request_stack', '@entity.repository']
    tags:
      - { name: commerce_store.store_resolver, priority: 100 }

  commerce_api.collect_resource_object_meta_subscriber:
    class: Drupal\commerce_api\EventSubscriber\CollectResourceObjectMetaSubscriber
    arguments: ['@entity.repository', '@commerce_shipping.order_manager']
    tags:
      - { name: event_subscriber }

  commerce_api.normalizer.resource_object.jsonapi:
    class: Drupal\jsonapi\Normalizer\CommerceApiImposter\MetaResourceObjectNormalizer
    decorates: 'serializer.normalizer.resource_object.jsonapi'
    parent: 'serializer.normalizer.resource_object.jsonapi'
    calls:
      - [setEventDispatcher, ['@event_dispatcher']]
      - [setRenderer, ['@renderer']]
